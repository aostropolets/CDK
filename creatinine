IF OBJECT_ID('tempdb..#tmpCrDemo') IS NOT NULL
	DROP TABLE #tmpCrDemo;
CREATE TABLE #tmpCrDemo (
	person_id INT NOT NULL
	,crVal FLOAT
	,crDt DATETIME2(6)
	,crCd VARCHAR(100)
	,ageAtMeasYear INT
	,birthDate DATETIME2(6)
	,genderFemale varchar(10)
	,raceBlack varchar(10)
	);
	
SELECT
		person_id, gender_concept_id, race_concept_id,  
		measurement_start_date, extract(year from measurement_start_date) - year_of_birth as ageAtMeasYear
		measurement_concept_id, 
		case 
		when unit_concept_id = 8840 then value_as_number-- mg/dl
		when unit_concept_id = 8842 then value_as_number*0.0001 -- ng/ml
		when unit_concept_id = 8749 then value_as_number*0.0113  -- mcmol/l
		when unit_concept_id = when unit_concept_id =9586 then value_as_number*11300 -- mol/l
		when unit_concept_id = 8753 then value_as_number*11.3 -- mmol/l 
		when unit_concept_id = 8636 then value_as_number*1000-- g/l
		else null end as value_as_number
		value_as_concept_id,
		value_as_string
FROM MEASUREMENT
JOIN PERSON on
JOIN CKD_codes on measurement_concept_id = concept_id and category = 'creatinine' 
;
